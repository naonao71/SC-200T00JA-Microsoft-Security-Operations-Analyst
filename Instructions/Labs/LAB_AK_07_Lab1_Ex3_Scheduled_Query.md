# モジュール 7 - ラボ 1 - 演習 3 - スケジュールされたクエリを作成する

## ラボ シナリオ

![Lab overview.](../Media/SC-200-Lab_Diagrams_Mod7_L1_Ex3.png)

あなたは、Microsoft Sentinelを導入した企業に勤務するセキュリティ・オペレーション・アナリストです。Microsoft Sentinelを使用して、脅威を検出し、軽減する方法を学ぶ必要があります。データソースをMicrosoft Sentinelに接続した後、カスタム分析ルールを作成して、環境内の脅威と異常な動作を発見するのに役立ちます。

分析ルールは、環境全体で特定のイベントまたはイベントのセットを検索し、特定のイベントの閾値または条件に達するとアラートして、SOCがトリアージと調査を行うためのインシデントを生成し、自動追跡と再メディエーションプロセスによって脅威に対応します。

### タスク 1: スケジュール済みクエリを作成します。

このタスクでは、スケジュールされたクエリを作成し、前の演習で作成した Teams チャネルに接続します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのメール** アカウントをコピーして貼り付け、「**次へ**」を選択します。

3. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード** をコピーして貼り付け、「**サインイン**」を選択します。

4. Azure portal の検索バーに「*Sentinel*」と入力してから、「**Microsoft Sentinel**」を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. 構成領域から「**分析**」を選択します。

7. 「**+ 作成**」ボタンを選択し、「**スケジュール済みクエリ ルール**」を選択します。

8. 分析ルール ウィザードの「全般」タブで、名前 *Azure AD Role Assignment Audit Trail* を入力します。

9. 戦術については、「**Persistence**」を選択します。

10. 重大度については、「**低**」を選択します。

11. 「**次へ: ルールのロジックを設定 >**」ボタンを選択します。

12. ルールクエリの場合は、次のKQLステートメントを貼り付けます。

**警告:** 仮想マシンへの貼り付け機能を使用する場合。  追加 | （パイプ）文字を追加できます。まず、メモ帳を使用して、次のクエリを貼り付けてください。

```KQL
AuditLogs 
| where isnotempty(InitiatedBy.user.userPrincipalName) and Result == 'success' and OperationName contains "member to role" and AADOperationType startswith "Assign"
| extend InitiatedByUPN = tostring(InitiatedBy.user.userPrincipalName)
| extend InitiatedFromIP = iff(tostring(AdditionalDetails.[7].value) == '', tostring(AdditionalDetails.[6].value), tostring(AdditionalDetails.[7].value))
| extend TargetUser = tostring(TargetResources.[2].displayName)
| extend TargetRoleName = tostring(TargetResources.[0].displayName)
| project TimeGenerated, InitiatedByUPN, InitiatedFromIP, TargetUser, TargetRoleName, AADOperationType, OperationName
```

> **注:** "クエリ結果の表示" へのリンクを選択した場合、結果またはエラーは表示されません。エラーが表示された場合は、クエリが以前の KQL ステートメントに類似していることを確認してください。

13. 「*Alert enrichment (Preview)*」 (アラート エンリッチメント (プレビュー)) 領域で、「*エンティティ マッピング*」を選択し、次の値を選択します。**エンティティの型:** Account、**ID:** FullName、**値:** InitiatedByUPN、次に「*新しいエンティティの追加*」を選択し、次の値をを選択します。**エンティティの型:** IP、**ID:** Address、**値:** InitiatedFromIP

|設定|値|
|:----|:----|
|エンティティの型|Account|
|ID|FullName|
|値|InitiatedByUPN|

|設定|値|
|:----|:----|
|エンティティの型|IP|
|ID|Address|
|値|InitiatedFromIP|

14. **クエリのスケジュール設定**領域で、「*クエリの実行間隔*」オプションに対して**5** を入力し、「**分**」を選択します。「*次の時間分の過去のデータを参照します*」オプションに対して**1** を入力し、「**日**」を選択します。

|設定|値|
|:----|:----|
|クエリの実行間隔|5 分|
|次の時間分の過去のデータを参照します|1 日|

> **注:** 同じデータに対して意図的に多くのインシデントを生成しています。これにより、ラボはこれらのアラートを使用できるようになります。

15. **アラートのしきい値** 領域では、オプションを変更しないでください。

> **注:** 一番の練習はアラートルールのKQLクエリステートメントでスレッショルドを管理することです。

16. **イベント グループ化**領域では、選択したオプションとして、**すべてのイベントを単一のアラートにグループ化する** のままにします。

17. 「**次: インシデントの設定 >**」ボタンを選択します。  

18. **インシデントの設定 ** タブで、既定のオプションを確認します。

19. 「**次: 自動応答 >**」ボタンを選択します。

20. 「**アラートのオートメーション（クラッシック）**」を展開しドロップダウンリストから、前の演習で作成したプレイブック **PostMessageTeams-OnAlert** を選択します。

21. 「自動化ルール」の下にある、「新規追加」をクリックします。

22. オートメーションルール名に「rule1」、アクションのドロップダウンリストから「**所有者の割り当て**」を選択します。

23. そして、「自分への割り当て」を選択します。

22. 「**次: レビュー >**」ボタンを選択します。
  
23. 「**作成**」 を選択します。

### タスク 2: 新しいルールをテストします。

このタスクでは、新しいスケジュールされたクエリルールをテストします

1. Azureポータルの検索バーに「*Azure Active Directory*」と入力します。「**Azure Active Directory**」を選択します。

2. 管理領域で「**ユーザー**」を選択し、"ユーザー | すべてのユーザー (プレビュー)" ページが表示されるようにします。

3. リストからユーザー「**Christie Cline**」を選択すると、"Christie Cline の | プロファイル" ページが表示されます。

4. 管理領域で「**割り当てられたロール**」を選択し、"Christie Cline | 割り当てられたロール" ページが表示されます。

5. コマンド バーから「**+ 割り当ての追加**」を選択します。

6. **ディレクトリロール** で、「**ユーザー管理者**」を選択し、「**追加**」を選択します。

7. 割り当ての完了に失敗した場合は、再試行してください。

8. "Christie Cline | の割り当てられたロール" と "ユーザー | すべてのユーザー (プレビュー)" ページを右上の「x」を 2 回選択して閉じます。

9. "Contoso | の概要" ページの「*監視*」の下で、「**監査ログ**」を選択します。

10. 「**データ設定のエクスポート**」を選択して、"Azure Active Directory" のデータ コネクタが、Sentinel で正しく設定されていることを確認します。

11. Sentinel に対して以前に作成した *Log Analytics ワークスペース*の*診断設定*エントリがあることを確認します。

12. 右上の「x」を選択して、ページを閉じます。

13. 「**更新**」をクリックして以前に作成したロールに変更を示す **カテゴリ** に **RoleManagement** に対するエントリが表示されるのを確認します。

14. Azure portal の検索バーに「*Sentinel*」と入力してから、「**Microsoft Sentinel**」を選択します。

15. Microsoft Sentinel ワークスペースを選択します。

16. **インシデント** メニュー オプションを選択します。

> **注:** トリガーされたアラートの処理には 5 分以上かかる場合があります。次の演習を続けて、後でこのポイントに戻ることができます。インシデント ページの自動更新については、「**Auto-refresh incidents**」 (自動更新:インシデント) トグルを選択します。

17. 新しく作成したインシデントが表示されます。インシデントを選択し、右側のブレードの情報を確認します。

18. ブラウザー タブを開き、https://teams.microsoft.com にアクセスして、Microsoft Teams を開きます。*SOC* チームに移動し、インシデントに関するメッセージ投稿を参照してください。

## 演習 4 に進みます。
